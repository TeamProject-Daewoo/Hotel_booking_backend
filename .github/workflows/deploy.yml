name: Build Backend and Deploy All Services

on:
  push:
    branches: [ "main" ] # 1. main ë¸Œëœì¹˜ì— pushë  ë•Œ
  repository_dispatch:
    types: [ deploy-trigger ] # 2. deploy-trigger ì‹ í˜¸ë¥¼ ë°›ì•˜ì„ ë•Œ

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. AWS ìê²© ì¦ëª… ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 2. Amazon ECRì— ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # 3. ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Push
      - name: Build and push backend image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: hotelhub/backend
          IMAGE_TAG: latest
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # 4. EC2ì— ì ‘ì†í•˜ì—¬ ì „ì²´ ì„œë¹„ìŠ¤ ë°°í¬
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ${{ secrets.AWS_EC2_USER }}
          key: ${{ secrets.AWS_EC2_KEY }}
          script: |
            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (ì—†ìœ¼ë©´ ìƒì„±í•˜ê³  git clone)
            if [ ! -d "/home/ubuntu/app" ]; then
              git clone https://github.com/your-github-username/user-backend.git /home/ubuntu/app # ğŸ‘ˆ ì´ ë¶€ë¶„
            fi
            cd /home/ubuntu/app
            git pull origin main # ìµœì‹  docker-compose.yml, nginx.conf ì—…ë°ì´íŠ¸

            # ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | sudo docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}

            # ìµœì‹  ì´ë¯¸ì§€ Pull
            sudo docker pull ${{ steps.login-ecr.outputs.registry }}/my-app-backend:latest
            sudo docker pull ${{ steps.login-ecr.outputs.registry }}/my-app-frontend:latest

            # DB ì ‘ì† ì •ë³´ë¥¼ ë‹´ì€ .env íŒŒì¼ ìƒì„±
            sudo tee .env <<EOF
            DB_URL=${{ secrets.DB_URL }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            EOF
            
            # Docker Composeë¡œ ì„œë¹„ìŠ¤ ì‹¤í–‰
            sudo docker-compose up -d
