# --- 백엔드 서버 그룹 정의 ---
upstream user_api {
    server user-backend:8080;
}
upstream management_api {
    server management-backend:8080;
}

server {
    listen 80;
    # www가 붙은 주소와 안 붙은 주소 모두 받음
    server_name www.hotelhub.store hotelhub.store;

    # Let's Encrypt 갱신을 위한 경로는 예외 (가장 먼저 처리)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 그 외 모든 요청은 www를 붙여서 HTTPS로 영구 이동(301)
    location / {
        return 301 https://www.hotelhub.store$request_uri;
    }
}

# ⭐️ 2. HTTPS(443) non-www 요청을 www로 리디렉션 ⭐️
server {
    listen 443 ssl;
    # www가 없는 주소만 처리
    server_name hotelhub.store;

    # SSL 인증서 경로 설정 (동일하게 필요)
    ssl_certificate /etc/letsencrypt/live/hotelhub.store/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/hotelhub.store/privkey.pem;

    # 모든 요청을 www 주소로 영구 이동(301)
    return 301 https://www.hotelhub.store$request_uri;
}

server {
    listen 443 ssl;
    server_name www.hotelhub.store hotelhub.store;

    ssl_certificate /etc/letsencrypt/live/www.hotelhub.store/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.hotelhub.store/privkey.pem;

    
    # --- API 경로 분기 ---
    # /api/admin 으로 시작하는 요청은 관리자 백엔드로 전달
    location /admin/api/ {
        rewrite ^/admin(/api/.*)$ $1 break;
        proxy_pass http://management_api;
        proxy_set_header Host $host;
    }
    location /business/api/ {
        rewrite ^/business(/api/.*)$ $1 break;
        proxy_pass http://management_api;
        proxy_set_header Host $host;
    }
    # /api 로 시작하는 그 외 모든 요청은 사용자 백엔드로 전달
    location /api/ {
        proxy_pass http://user_api;
        proxy_set_header Host $host;
    }

    # --- 프론트엔드 경로 분기 ---
    # /admin 으로 시작하는 요청은 관리자 프론트엔드로 전달
    location /admin/ {
        proxy_pass http://admin-frontend:80/;
    }
    # /business 으로 시작하는 요청은 사업자 프론트엔드로 전달
    location /business/ {
        proxy_pass http://business-frontend:80/;
    }
    # 그 외 모든 요청은 사용자 프론트엔드로 전달 (SPA 설정 포함)
    location / {
        proxy_pass http://user-frontend:80/;
    }
}
