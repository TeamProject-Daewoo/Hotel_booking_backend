# --- 백엔드 서버 그룹 정의 ---
upstream user_api {
    server user-backend:8080;
}
upstream management_api {
    server management-backend:8080;
}

server {
    listen 80;
    # 기본 도메인과 www 도메인만 처리
    server_name www.hotelhub.store hotelhub.store;

    # Let's Encrypt 갱신을 위한 경로
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 나머지 모든 HTTP 요청은 HTTPS로 보냄
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name www.hotelhub.store hotelhub.store;

    ssl_certificate /etc/letsencrypt/live/www.hotelhub.store/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.hotelhub.store/privkey.pem;

    
    # --- API 경로 분기 ---
    # /api/admin 으로 시작하는 요청은 관리자 백엔드로 전달
    location /admin/api/ {
        rewrite ^/admin(/api/.*)$ $1 break;
        proxy_pass http://management_api;
        proxy_set_header Host $host;
    }
    location /business/api/ {
        rewrite ^/business(/api/.*)$ $1 break;
        proxy_pass http://management_api;
        proxy_set_header Host $host;
    }
    # /api 로 시작하는 그 외 모든 요청은 사용자 백엔드로 전달
    location /api/ {
        proxy_pass http://user_api;
        proxy_set_header Host $host;
    }

    # --- 프론트엔드 경로 분기 ---
    # /admin 으로 시작하는 요청은 관리자 프론트엔드로 전달
    location /admin/ {
        proxy_pass http://admin-frontend:80/;
    }
    # /business 으로 시작하는 요청은 사업자 프론트엔드로 전달
    location /business/ {
        proxy_pass http://business-frontend:80/;
    }
    # 그 외 모든 요청은 사용자 프론트엔드로 전달 (SPA 설정 포함)
    location / {
        proxy_pass http://user-frontend:80/;
    }
}
